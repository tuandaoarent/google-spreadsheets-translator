<script>
  // Setting name constants
  const SETTING_NAMES = {
    FULL_SHEET: 'fullSheet',
    DUPLICATE_SHEET: 'duplicateSheet',
    BACKGROUND_COLOR: 'backgroundColor'
  };

  // Translation settings
  let settings = {
    [SETTING_NAMES.FULL_SHEET]: false,
    [SETTING_NAMES.DUPLICATE_SHEET]: true,
    [SETTING_NAMES.BACKGROUND_COLOR]: true
  };

  // Language options - comprehensive list matching the image
  const languages = [
    { countryCode: 'auto', languageCode: 'auto', name: 'Auto detect', codeDisplay: '' },
    { countryCode: 'us', languageCode: 'en', name: 'English', codeDisplay: '🇺🇸' },
    { countryCode: 'fr', languageCode: 'fr', name: 'French', codeDisplay: '🇫🇷' },
    { countryCode: 'de', languageCode: 'de', name: 'German', codeDisplay: '🇩🇪' },
    { countryCode: 'it', languageCode: 'it', name: 'Italian', codeDisplay: '🇮🇹' },
    { countryCode: 'es', languageCode: 'es', name: 'Spanish', codeDisplay: '🇪🇸' },
    { countryCode: 'za', languageCode: 'af', name: 'Afrikaans', codeDisplay: '' },
    { countryCode: 'al', languageCode: 'sq', name: 'Albanian', codeDisplay: '🇦🇱' },
    { countryCode: 'sa', languageCode: 'ar', name: 'Arabic', codeDisplay: '🇸🇦' },
    { countryCode: 'az', languageCode: 'az', name: 'Azerbaijani', codeDisplay: '🇦🇿' },
    { countryCode: 'es', languageCode: 'eu', name: 'Basque', codeDisplay: '' },
    { countryCode: 'bd', languageCode: 'bn', name: 'Bengali', codeDisplay: '' },
    { countryCode: 'by', languageCode: 'be', name: 'Belarusian', codeDisplay: '🇧🇾' },
    { countryCode: 'bg', languageCode: 'bg', name: 'Bulgarian', codeDisplay: '🇧🇬' },
    { countryCode: 'mm', languageCode: 'my', name: 'Burmese', codeDisplay: '🇲🇲' },
    { countryCode: 'es', languageCode: 'ca', name: 'Catalan', codeDisplay: '' },
    { countryCode: 'cn', languageCode: 'zh', name: 'Chinese (Simplified)', codeDisplay: '🇨🇳' },
    { countryCode: 'tw', languageCode: 'zh-tw', name: 'Chinese (Traditional)', codeDisplay: '🇹🇼' },
    { countryCode: 'hr', languageCode: 'hr', name: 'Croatian', codeDisplay: '🇭🇷' },
    { countryCode: 'cz', languageCode: 'cs', name: 'Czech', codeDisplay: '🇨🇿' },
    { countryCode: 'dk', languageCode: 'da', name: 'Danish', codeDisplay: '🇩🇰' },
    { countryCode: 'nl', languageCode: 'nl', name: 'Dutch', codeDisplay: '🇳🇱' },
    { countryCode: 'ee', languageCode: 'et', name: 'Estonian', codeDisplay: '🇪🇪' },
    { countryCode: 'fi', languageCode: 'fi', name: 'Finnish', codeDisplay: '🇫🇮' },
    { countryCode: 'gr', languageCode: 'el', name: 'Greek', codeDisplay: '🇬🇷' },
    { countryCode: 'il', languageCode: 'he', name: 'Hebrew', codeDisplay: '🇮🇱' },
    { countryCode: 'in', languageCode: 'hi', name: 'Hindi', codeDisplay: '🇮🇳' },
    { countryCode: 'hu', languageCode: 'hu', name: 'Hungarian', codeDisplay: '🇭🇺' },
    { countryCode: 'is', languageCode: 'is', name: 'Icelandic', codeDisplay: '🇮🇸' },
    { countryCode: 'id', languageCode: 'id', name: 'Indonesian', codeDisplay: '🇮🇩' },
    { countryCode: 'ie', languageCode: 'ga', name: 'Irish', codeDisplay: '🇮🇪' },
    { countryCode: 'jp', languageCode: 'ja', name: 'Japanese', codeDisplay: '🇯🇵' },
    { countryCode: 'kr', languageCode: 'ko', name: 'Korean', codeDisplay: '🇰🇷' },
    { countryCode: 'lv', languageCode: 'lv', name: 'Latvian', codeDisplay: '🇱🇻' },
    { countryCode: 'lt', languageCode: 'lt', name: 'Lithuanian', codeDisplay: '🇱🇹' },
    { countryCode: 'mk', languageCode: 'mk', name: 'Macedonian', codeDisplay: '🇲🇰' },
    { countryCode: 'my', languageCode: 'ms', name: 'Malay', codeDisplay: '🇲🇾' },
    { countryCode: 'mt', languageCode: 'mt', name: 'Maltese', codeDisplay: '🇲🇹' },
    { countryCode: 'no', languageCode: 'no', name: 'Norwegian', codeDisplay: '🇳🇴' },
    { countryCode: 'ir', languageCode: 'fa', name: 'Persian', codeDisplay: '🇮🇷' },
    { countryCode: 'pl', languageCode: 'pl', name: 'Polish', codeDisplay: '🇵🇱' },
    { countryCode: 'pt', languageCode: 'pt', name: 'Portuguese', codeDisplay: '🇵🇹' },
    { countryCode: 'ro', languageCode: 'ro', name: 'Romanian', codeDisplay: '🇷🇴' },
    { countryCode: 'ru', languageCode: 'ru', name: 'Russian', codeDisplay: '🇷🇺' },
    { countryCode: 'rs', languageCode: 'sr', name: 'Serbian', codeDisplay: '🇷🇸' },
    { countryCode: 'sk', languageCode: 'sk', name: 'Slovak', codeDisplay: '🇸🇰' },
    { countryCode: 'si', languageCode: 'sl', name: 'Slovenian', codeDisplay: '🇸🇮' },
    { countryCode: 'tz', languageCode: 'sw', name: 'Swahili', codeDisplay: '🇹🇿' },
    { countryCode: 'se', languageCode: 'sv', name: 'Swedish', codeDisplay: '🇸🇪' },
    { countryCode: 'th', languageCode: 'th', name: 'Thai', codeDisplay: '🇹🇭' },
    { countryCode: 'tr', languageCode: 'tr', name: 'Turkish', codeDisplay: '🇹🇷' },
    { countryCode: 'ua', languageCode: 'uk', name: 'Ukrainian', codeDisplay: '🇺🇦' },
    { countryCode: 'pk', languageCode: 'ur', name: 'Urdu', codeDisplay: '🇵🇰' },
    { countryCode: 'vn', languageCode: 'vi', name: 'Vietnamese', codeDisplay: '🇻🇳' },
    { countryCode: 'gb', languageCode: 'cy', name: 'Welsh', codeDisplay: '🇬🇧' }
  ];

  let selectedSourceLanguage = 'auto';
  let selectedTargetLanguage = 'en';
  let sourceDropdownOpen = false;
  let targetDropdownOpen = false;

  // Status types constants
  const STATUS_TYPES = {
    SUCCESS: 'success',
    ERROR: 'error'
  };

  // Load initial data when sidebar opens
  document.addEventListener('DOMContentLoaded', function () {
    initializeUI();
  });

  /**
   * Initialize the UI
   */
  function initializeUI() {
    // Set default languages
    selectedSourceLanguage = 'auto';
    selectedTargetLanguage = 'en';

    populateDropdowns();
    updateLanguageDisplay();
    updateToggleStates();
    setupClickOutside();
    setupHelpOverlay();
  }

  /**
   * Populate dropdown menus with language options
   */
  function populateDropdowns() {
    const sourceGroup = document.getElementById('sourceLanguageGroup');
    const targetGroup = document.getElementById('targetLanguageGroup');
    const sourceOptions = sourceGroup.querySelector('.language-options');
    const targetOptions = targetGroup.querySelector('.language-options');

    // Populate source dropdown (includes auto detect)
    sourceOptions.innerHTML = '';
    languages.forEach(lang => {
      const item = createDropdownItem(lang, 'source');
      sourceOptions.appendChild(item);
    });

    // Populate target dropdown (excludes auto detect)
    targetOptions.innerHTML = '';
    languages.filter(lang => lang.languageCode !== 'auto').forEach(lang => {
      const item = createDropdownItem(lang, 'target');
      targetOptions.appendChild(item);
    });
  }

  /**
   * Create a dropdown item element using HTML template
   * @param {Object} lang - Language object
   * @param {string} type - 'source' or 'target'
   */
  function createDropdownItem(lang, type) {
    const template = document.getElementById('dropdownItemTemplate');
    const item = template.content.cloneNode(true);
    const dropdownItem = item.querySelector('.dropdown-item');

    // Set data attributes and classes
    dropdownItem.setAttribute('data-code', lang.countryCode);

    if ((type === 'source' && lang.languageCode === selectedSourceLanguage) ||
      (type === 'target' && lang.languageCode === selectedTargetLanguage)) {
      dropdownItem.classList.add('selected');
    }

    // Populate template content
    const countryCode = dropdownItem.querySelector('.country-code');
    const languageIcon = dropdownItem.querySelector('.language-icon');
    const languageName = dropdownItem.querySelector('.language-name');

    // Special case for Auto Detect - hide country code
    if (lang.languageCode === 'auto') {
      countryCode.style.display = 'none';
    } else {
      countryCode.textContent = lang.codeDisplay;
      countryCode.style.display = 'inline';
    }

    // languageIcon.textContent = lang.icon;
    updateFlagClass(languageIcon, lang.countryCode);
    languageName.textContent = lang.name;

    // Add click event
    dropdownItem.onclick = () => selectLanguage(lang.languageCode, type);

    return item;
  }

  /**
   * Toggle source language dropdown
   */
  function toggleSourceDropdown() {
    if (targetDropdownOpen) {
      closeTargetDropdown();
    }
    sourceDropdownOpen = !sourceDropdownOpen;
    const sourceGroup = document.getElementById('sourceLanguageGroup');
    const dropdown = sourceGroup.querySelector('.dropdown-menu');
    const input = sourceGroup.querySelector('.language-input');

    if (sourceDropdownOpen) {
      dropdown.classList.add('open');
      input.classList.add('open');
      // Focus the filter input when dropdown opens
      setTimeout(() => {
        sourceGroup.querySelector('.language-filter').focus();
      }, 100);
    } else {
      dropdown.classList.remove('open');
      input.classList.remove('open');
      // Clear filter when closing
      const filterInput = sourceGroup.querySelector('.language-filter');
      filterInput.value = '';
      filterLanguages('source', '');
    }
  }

  /**
   * Toggle target language dropdown
   */
  function toggleTargetDropdown() {
    if (sourceDropdownOpen) {
      closeSourceDropdown();
    }
    targetDropdownOpen = !targetDropdownOpen;
    const targetGroup = document.getElementById('targetLanguageGroup');
    const dropdown = targetGroup.querySelector('.dropdown-menu');
    const input = targetGroup.querySelector('.language-input');

    if (targetDropdownOpen) {
      dropdown.classList.add('open');
      input.classList.add('open');
      // Focus the filter input when dropdown opens
      setTimeout(() => {
        targetGroup.querySelector('.language-filter').focus();
      }, 100);
    } else {
      dropdown.classList.remove('open');
      input.classList.remove('open');
      // Clear filter when closing
      const filterInput = targetGroup.querySelector('.language-filter');
      filterInput.value = '';
      filterLanguages('target', '');
    }
  }

  /**
   * Close source dropdown
   */
  function closeSourceDropdown() {
    sourceDropdownOpen = false;
    const sourceGroup = document.getElementById('sourceLanguageGroup');
    const dropdown = sourceGroup.querySelector('.dropdown-menu');
    const input = sourceGroup.querySelector('.language-input');
    dropdown.classList.remove('open');
    input.classList.remove('open');
  }

  /**
   * Close target dropdown
   */
  function closeTargetDropdown() {
    targetDropdownOpen = false;
    const targetGroup = document.getElementById('targetLanguageGroup');
    const dropdown = targetGroup.querySelector('.dropdown-menu');
    const input = targetGroup.querySelector('.language-input');
    dropdown.classList.remove('open');
    input.classList.remove('open');
  }

  /**
   * Select a language
   * @param {string} code - Language code
   * @param {string} type - 'source' or 'target'
   */
  function selectLanguage(code, type) {
    if (type === 'source') {
      selectedSourceLanguage = code;
      closeSourceDropdown();
      updateLanguageDisplay('source');
    } else {
      selectedTargetLanguage = code;
      closeTargetDropdown();
      updateLanguageDisplay('target');
    }

    populateDropdowns(); // Refresh to update selected states
  }

  /**
   * Update flag class for a language icon element
   * @param {HTMLElement} iconElement - The icon element to update
   * @param {string} countryCode - The country code for the flag class
   */
  function updateFlagClass(iconElement, countryCode) {
    // Remove existing flag classes
    iconElement.className = iconElement.className.replace(/fi-\w+/g, '');

    // Special case for Auto Detect - show globe icon
    if (countryCode === 'auto') {
      iconElement.classList.remove('fi');
      iconElement.textContent = '🌐';
    } else {
      iconElement.textContent = '';
      // Add new flag class
      iconElement.classList.add('fi');
      iconElement.classList.add('fi-' + countryCode);
    }
  }

  /**
   * Update language display
   * @param {string} type - 'source', 'target', or undefined for both
   */
  function updateLanguageDisplay(type) {
    if (type === 'source' || type === undefined) {
      const sourceLang = languages.find(lang => lang.languageCode === selectedSourceLanguage);
      document.querySelector('#sourceLanguageGroup .language-text').textContent = sourceLang.name;

      // Update source icon
      const sourceIcon = document.querySelector('#sourceLanguageGroup .language-icon');
      updateFlagClass(sourceIcon, sourceLang.countryCode);
    }

    if (type === 'target' || type === undefined) {
      const targetLang = languages.find(lang => lang.languageCode === selectedTargetLanguage);
      document.querySelector('#targetLanguageGroup .language-text').textContent = targetLang.name;

      // Update target icon
      const targetIcon = document.querySelector('#targetLanguageGroup .language-icon');
      updateFlagClass(targetIcon, targetLang.countryCode);
    }
  }

  /**
   * Filter languages based on search term
   * @param {string} type - 'source' or 'target'
   * @param {string} searchTerm - The search term to filter by
   */
  function filterLanguages(type, searchTerm) {
    const groupElement = document.getElementById(type + 'LanguageGroup');
    const optionsContainer = groupElement.querySelector('.language-options');
    const noResultsContainer = groupElement.querySelector('.no-results');
    const items = optionsContainer.querySelectorAll('.dropdown-item');

    const term = searchTerm.toLowerCase().trim();
    let visibleCount = 0;

    items.forEach(item => {
      const languageName = item.querySelector('.language-name').textContent.toLowerCase();
      const countryCode = item.querySelector('.country-code').textContent.toLowerCase();

      // Show item if search term matches language name or country code
      if (term === '' || languageName.includes(term) || countryCode.includes(term)) {
        item.style.display = 'flex';
        visibleCount++;
      } else {
        item.style.display = 'none';
      }
    });

    // Show/hide no results message
    if (visibleCount === 0 && term !== '') {
      noResultsContainer.style.display = 'block';
    } else {
      noResultsContainer.style.display = 'none';
    }
  }

  /**
   * Clear the filter input and reset the dropdown
   * @param {string} type - 'source' or 'target'
   */
  function clearFilter(type) {
    const groupElement = document.getElementById(type + 'LanguageGroup');
    const filterInput = groupElement.querySelector('.language-filter');

    // Clear the input value
    filterInput.value = '';

    // Reset the filter to show all languages
    filterLanguages(type, '');

    // Focus back to the input for better UX
    filterInput.focus();
  }

  /**
   * Setup click outside to close dropdowns
   */
  function setupClickOutside() {
    document.addEventListener('click', function (event) {
      const sourceSelect = document.querySelector('#sourceLanguageGroup .language-select');
      const targetSelect = document.querySelector('#targetLanguageGroup .language-select');

      if (!sourceSelect.contains(event.target) && sourceDropdownOpen) {
        closeSourceDropdown();
      }

      if (!targetSelect.contains(event.target) && targetDropdownOpen) {
        closeTargetDropdown();
      }
    });

    // Prevent dropdown from closing when clicking on filter inputs or clear buttons
    document.addEventListener('click', function (event) {
      if (event.target.classList.contains('language-filter') || event.target.classList.contains('clear-filter')) {
        event.stopPropagation();
      }
    });
  }

  /**
   * Toggle a setting
   * @param {string} settingName - The name of the setting to toggle
   */
  function toggleSetting(settingName) {
    settings[settingName] = !settings[settingName];
    updateToggleStates();
  }

  /**
   * Update toggle switch states
   */
  function updateToggleStates() {
    Object.keys(settings).forEach(setting => {
      const toggle = document.getElementById(setting + 'Toggle');
      if (settings[setting]) {
        toggle.classList.add('active');
      } else {
        toggle.classList.remove('active');
      }
    });
  }

  /**
   * Translate content
   */
  function translateContent() {
    // Disable the translate button
    const translateButton = document.querySelector('.translate-button');
    translateButton.disabled = true;
    translateButton.textContent = 'TRANSLATING...';
    translateButton.classList.add('translating');


    if (typeof google !== 'undefined' && google.script && google.script.run) {
      if (settings[SETTING_NAMES.DUPLICATE_SHEET]) {
        showStatus('Duplicating sheet...', STATUS_TYPES.SUCCESS);

        google.script.run
          .withSuccessHandler(() => {
            // After successful duplication, perform translation
            performTranslation(selectedSourceLanguage, selectedTargetLanguage, enableTranslateButton);
          })
          .withFailureHandler((error) => {
            enableTranslateButton();
            showStatus(`Failed to duplicate sheet: ${error}`, STATUS_TYPES.ERROR);
          })
          .duplicateActiveSheet();
      }
      else {
        performTranslation(selectedSourceLanguage, selectedTargetLanguage, enableTranslateButton);
      }
    } else {
      enableTranslateButton();
      showStatus('Google Apps Script environment not available. This is a demo mode.', STATUS_TYPES.ERROR);
    }
  }

  /**
   * Perform the actual translation operation
   */
  function performTranslation(sourceLanguage, targetLanguage, finalCb) {
    showStatus('Translating...', STATUS_TYPES.SUCCESS);

    const translationContext = google.script.run
      .withSuccessHandler(() => {
        finalCb();
        const sourceLang = languages.find(lang => lang.languageCode === sourceLanguage);
        const targetLang = languages.find(lang => lang.languageCode === targetLanguage);
        const sourceName = sourceLang ? sourceLang.name : sourceLanguage;
        const targetName = targetLang ? targetLang.name : targetLanguage;
        showStatus(`Translation completed from ${sourceName} to ${targetName}`, STATUS_TYPES.SUCCESS);
      })
      .withFailureHandler((error) => {
        finalCb();
        showStatus(error, STATUS_TYPES.ERROR);
      });

    if (settings[SETTING_NAMES.FULL_SHEET]) {
      translationContext.translateCurrentSheet(sourceLanguage, targetLanguage);
    }
    else {
      translationContext.translateSelected(sourceLanguage, targetLanguage);
    }
  }

  /**
   * Enable the translate button
   */
  function enableTranslateButton() {
    const translateButton = document.querySelector('.translate-button');
    translateButton.disabled = false;
    translateButton.textContent = 'TRANSLATE';
    translateButton.classList.remove('translating');
  }

  /**
   * Show help overlay
   */
  function showHelp() {
    const overlay = document.getElementById('helpOverlay');
    overlay.style.display = 'flex';
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
  }

  /**
   * Close help overlay
   */
  function closeHelp() {
    const overlay = document.getElementById('helpOverlay');
    overlay.style.display = 'none';
    document.body.style.overflow = 'auto'; // Restore scrolling
  }

  /**
   * Setup help overlay event listeners
   */
  function setupHelpOverlay() {
    const overlay = document.getElementById('helpOverlay');

    // Close on overlay background click
    overlay.addEventListener('click', function (e) {
      if (e.target === overlay) {
        closeHelp();
      }
    });

    // Close on escape key
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && overlay.style.display === 'flex') {
        closeHelp();
      }
    });
  }

  /**
   * Shows a status message
   * @param {string} message - The message to show
   * @param {string} type - The type of message (success or error)
   */
  function showStatus(message, type) {
    const statusDiv = document.getElementById('status');
    statusDiv.textContent = message;
    statusDiv.className = 'status ' + type;
    statusDiv.style.display = 'block';
  }

  function hideStatus() {
    const statusDiv = document.getElementById('status');
    statusDiv.style.display = 'none';
  }

  function tryGetGoogleScriptContext(successHandler, failureHandler) {
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      return google.script.run
        .withSuccessHandler(successHandler)
        .withFailureHandler(failureHandler);
    }

    return null;
  }

</script>