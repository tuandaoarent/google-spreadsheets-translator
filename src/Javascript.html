<script>
  // Translation settings
  let settings = {
    fullSheet: false,
    duplicateSheet: true,
    backgroundColor: true
  };

  // Language options - comprehensive list matching the image
  const languages = [
    { countryCode: 'auto', languageCode: 'auto', name: 'Auto detect', codeDisplay: '' },
    { countryCode: 'us', languageCode: 'en', name: 'English', codeDisplay: 'ðŸ‡ºðŸ‡¸' },
    { countryCode: 'fr', languageCode: 'fr', name: 'French', codeDisplay: 'ðŸ‡«ðŸ‡·' },
    { countryCode: 'de', languageCode: 'de', name: 'German', codeDisplay: 'ðŸ‡©ðŸ‡ª' },
    { countryCode: 'it', languageCode: 'it', name: 'Italian', codeDisplay: 'ðŸ‡®ðŸ‡¹' },
    { countryCode: 'es', languageCode: 'es', name: 'Spanish', codeDisplay: 'ðŸ‡ªðŸ‡¸' },
    { countryCode: 'za', languageCode: 'af', name: 'Afrikaans', codeDisplay: '' },
    { countryCode: 'al', languageCode: 'sq', name: 'Albanian', codeDisplay: 'ðŸ‡¦ðŸ‡±' },
    { countryCode: 'sa', languageCode: 'ar', name: 'Arabic', codeDisplay: 'ðŸ‡¸ðŸ‡¦' },
    { countryCode: 'az', languageCode: 'az', name: 'Azerbaijani', codeDisplay: 'ðŸ‡¦ðŸ‡¿' },
    { countryCode: 'es', languageCode: 'eu', name: 'Basque', codeDisplay: '' },
    { countryCode: 'bd', languageCode: 'bn', name: 'Bengali', codeDisplay: '' },
    { countryCode: 'by', languageCode: 'be', name: 'Belarusian', codeDisplay: 'ðŸ‡§ðŸ‡¾' },
    { countryCode: 'bg', languageCode: 'bg', name: 'Bulgarian', codeDisplay: 'ðŸ‡§ðŸ‡¬' },
    { countryCode: 'mm', languageCode: 'my', name: 'Burmese', codeDisplay: 'ðŸ‡²ðŸ‡²' },
    { countryCode: 'es', languageCode: 'ca', name: 'Catalan', codeDisplay: '' },
    { countryCode: 'cn', languageCode: 'zh', name: 'Chinese (Simplified)', codeDisplay: 'ðŸ‡¨ðŸ‡³' },
    { countryCode: 'tw', languageCode: 'zh-tw', name: 'Chinese (Traditional)', codeDisplay: 'ðŸ‡¹ðŸ‡¼' },
    { countryCode: 'hr', languageCode: 'hr', name: 'Croatian', codeDisplay: 'ðŸ‡­ðŸ‡·' },
    { countryCode: 'cz', languageCode: 'cs', name: 'Czech', codeDisplay: 'ðŸ‡¨ðŸ‡¿' },
    { countryCode: 'dk', languageCode: 'da', name: 'Danish', codeDisplay: 'ðŸ‡©ðŸ‡°' },
    { countryCode: 'nl', languageCode: 'nl', name: 'Dutch', codeDisplay: 'ðŸ‡³ðŸ‡±' },
    { countryCode: 'ee', languageCode: 'et', name: 'Estonian', codeDisplay: 'ðŸ‡ªðŸ‡ª' },
    { countryCode: 'fi', languageCode: 'fi', name: 'Finnish', codeDisplay: 'ðŸ‡«ðŸ‡®' },
    { countryCode: 'gr', languageCode: 'el', name: 'Greek', codeDisplay: 'ðŸ‡¬ðŸ‡·' },
    { countryCode: 'il', languageCode: 'he', name: 'Hebrew', codeDisplay: 'ðŸ‡®ðŸ‡±' },
    { countryCode: 'in', languageCode: 'hi', name: 'Hindi', codeDisplay: 'ðŸ‡®ðŸ‡³' },
    { countryCode: 'hu', languageCode: 'hu', name: 'Hungarian', codeDisplay: 'ðŸ‡­ðŸ‡º' },
    { countryCode: 'is', languageCode: 'is', name: 'Icelandic', codeDisplay: 'ðŸ‡®ðŸ‡¸' },
    { countryCode: 'id', languageCode: 'id', name: 'Indonesian', codeDisplay: 'ðŸ‡®ðŸ‡©' },
    { countryCode: 'ie', languageCode: 'ga', name: 'Irish', codeDisplay: 'ðŸ‡®ðŸ‡ª' },
    { countryCode: 'jp', languageCode: 'ja', name: 'Japanese', codeDisplay: 'ðŸ‡¯ðŸ‡µ' },
    { countryCode: 'kr', languageCode: 'ko', name: 'Korean', codeDisplay: 'ðŸ‡°ðŸ‡·' },
    { countryCode: 'lv', languageCode: 'lv', name: 'Latvian', codeDisplay: 'ðŸ‡±ðŸ‡»' },
    { countryCode: 'lt', languageCode: 'lt', name: 'Lithuanian', codeDisplay: 'ðŸ‡±ðŸ‡¹' },
    { countryCode: 'mk', languageCode: 'mk', name: 'Macedonian', codeDisplay: 'ðŸ‡²ðŸ‡°' },
    { countryCode: 'my', languageCode: 'ms', name: 'Malay', codeDisplay: 'ðŸ‡²ðŸ‡¾' },
    { countryCode: 'mt', languageCode: 'mt', name: 'Maltese', codeDisplay: 'ðŸ‡²ðŸ‡¹' },
    { countryCode: 'no', languageCode: 'no', name: 'Norwegian', codeDisplay: 'ðŸ‡³ðŸ‡´' },
    { countryCode: 'ir', languageCode: 'fa', name: 'Persian', codeDisplay: 'ðŸ‡®ðŸ‡·' },
    { countryCode: 'pl', languageCode: 'pl', name: 'Polish', codeDisplay: 'ðŸ‡µðŸ‡±' },
    { countryCode: 'pt', languageCode: 'pt', name: 'Portuguese', codeDisplay: 'ðŸ‡µðŸ‡¹' },
    { countryCode: 'ro', languageCode: 'ro', name: 'Romanian', codeDisplay: 'ðŸ‡·ðŸ‡´' },
    { countryCode: 'ru', languageCode: 'ru', name: 'Russian', codeDisplay: 'ðŸ‡·ðŸ‡º' },
    { countryCode: 'rs', languageCode: 'sr', name: 'Serbian', codeDisplay: 'ðŸ‡·ðŸ‡¸' },
    { countryCode: 'sk', languageCode: 'sk', name: 'Slovak', codeDisplay: 'ðŸ‡¸ðŸ‡°' },
    { countryCode: 'si', languageCode: 'sl', name: 'Slovenian', codeDisplay: 'ðŸ‡¸ðŸ‡®' },
    { countryCode: 'tz', languageCode: 'sw', name: 'Swahili', codeDisplay: 'ðŸ‡¹ðŸ‡¿' },
    { countryCode: 'se', languageCode: 'sv', name: 'Swedish', codeDisplay: 'ðŸ‡¸ðŸ‡ª' },
    { countryCode: 'th', languageCode: 'th', name: 'Thai', codeDisplay: 'ðŸ‡¹ðŸ‡­' },
    { countryCode: 'tr', languageCode: 'tr', name: 'Turkish', codeDisplay: 'ðŸ‡¹ðŸ‡·' },
    { countryCode: 'ua', languageCode: 'uk', name: 'Ukrainian', codeDisplay: 'ðŸ‡ºðŸ‡¦' },
    { countryCode: 'pk', languageCode: 'ur', name: 'Urdu', codeDisplay: 'ðŸ‡µðŸ‡°' },
    { countryCode: 'vn', languageCode: 'vi', name: 'Vietnamese', codeDisplay: 'ðŸ‡»ðŸ‡³' },
    { countryCode: 'gb', languageCode: 'cy', name: 'Welsh', codeDisplay: 'ðŸ‡¬ðŸ‡§' }
  ];

  let selectedSourceLanguage = 'auto';
  let selectedTargetLanguage = 'en';
  let sourceDropdownOpen = false;
  let targetDropdownOpen = false;
  let statusTimeout = null;

  // Load initial data when sidebar opens
  document.addEventListener('DOMContentLoaded', function () {
    initializeUI();
  });

  /**
   * Initialize the UI
   */
  function initializeUI() {
    // Set default languages
    selectedSourceLanguage = 'auto';
    selectedTargetLanguage = 'en';

    populateDropdowns();
    updateLanguageDisplay();
    updateToggleStates();
    setupClickOutside();
    setupHelpOverlay();
  }

  /**
   * Populate dropdown menus with language options
   */
  function populateDropdowns() {
    const sourceDropdown = document.querySelector('#sourceLanguageGroup .dropdown-menu');
    const targetDropdown = document.querySelector('#targetLanguageGroup .dropdown-menu');

    // Populate source dropdown (includes auto detect)
    sourceDropdown.innerHTML = '';
    languages.forEach(lang => {
      const item = createDropdownItem(lang, 'source');
      sourceDropdown.appendChild(item);
    });

    // Populate target dropdown (excludes auto detect)
    targetDropdown.innerHTML = '';
    languages.filter(lang => lang.languageCode !== 'auto').forEach(lang => {
      const item = createDropdownItem(lang, 'target');
      targetDropdown.appendChild(item);
    });
  }

  /**
   * Create a dropdown item element using HTML template
   * @param {Object} lang - Language object
   * @param {string} type - 'source' or 'target'
   */
  function createDropdownItem(lang, type) {
    const template = document.getElementById('dropdownItemTemplate');
    const item = template.content.cloneNode(true);
    const dropdownItem = item.querySelector('.dropdown-item');

    // Set data attributes and classes
    dropdownItem.setAttribute('data-code', lang.countryCode);

    if ((type === 'source' && lang.languageCode === selectedSourceLanguage) ||
      (type === 'target' && lang.languageCode === selectedTargetLanguage)) {
      dropdownItem.classList.add('selected');
    }

    // Populate template content
    const countryCode = dropdownItem.querySelector('.country-code');
    const languageIcon = dropdownItem.querySelector('.language-icon');
    const languageName = dropdownItem.querySelector('.language-name');

    // Special case for Auto Detect - hide country code
    if (lang.languageCode === 'auto') {
      countryCode.style.display = 'none';
    } else {
      countryCode.textContent = lang.codeDisplay;
      countryCode.style.display = 'inline';
    }

    // languageIcon.textContent = lang.icon;
    updateFlagClass(languageIcon, lang.countryCode);
    languageName.textContent = lang.name;

    // Add click event
    dropdownItem.onclick = () => selectLanguage(lang.languageCode, type);

    return item;
  }

  /**
   * Toggle source language dropdown
   */
  function toggleSourceDropdown() {
    if (targetDropdownOpen) {
      closeTargetDropdown();
    }
    sourceDropdownOpen = !sourceDropdownOpen;
    const dropdown = document.querySelector('#sourceLanguageGroup .dropdown-menu');
    const input = document.querySelector('#sourceLanguageGroup .language-input');

    if (sourceDropdownOpen) {
      dropdown.classList.add('open');
      input.classList.add('open');
    } else {
      dropdown.classList.remove('open');
      input.classList.remove('open');
    }
  }

  /**
   * Toggle target language dropdown
   */
  function toggleTargetDropdown() {
    if (sourceDropdownOpen) {
      closeSourceDropdown();
    }
    targetDropdownOpen = !targetDropdownOpen;
    const dropdown = document.querySelector('#targetLanguageGroup .dropdown-menu');
    const input = document.querySelector('#targetLanguageGroup .language-input');

    if (targetDropdownOpen) {
      dropdown.classList.add('open');
      input.classList.add('open');
    } else {
      dropdown.classList.remove('open');
      input.classList.remove('open');
    }
  }

  /**
   * Close source dropdown
   */
  function closeSourceDropdown() {
    sourceDropdownOpen = false;
    const dropdown = document.querySelector('#sourceLanguageGroup .dropdown-menu');
    const input = document.querySelector('#sourceLanguageGroup .language-input');
    dropdown.classList.remove('open');
    input.classList.remove('open');
  }

  /**
   * Close target dropdown
   */
  function closeTargetDropdown() {
    targetDropdownOpen = false;
    const dropdown = document.querySelector('#targetLanguageGroup .dropdown-menu');
    const input = document.querySelector('#targetLanguageGroup .language-input');
    dropdown.classList.remove('open');
    input.classList.remove('open');
  }

  /**
   * Select a language
   * @param {string} code - Language code
   * @param {string} type - 'source' or 'target'
   */
  function selectLanguage(code, type) {
    if (type === 'source') {
      selectedSourceLanguage = code;
      closeSourceDropdown();
      updateLanguageDisplay('source');
    } else {
      selectedTargetLanguage = code;
      closeTargetDropdown();
      updateLanguageDisplay('target');
    }

    populateDropdowns(); // Refresh to update selected states
  }

  /**
   * Update flag class for a language icon element
   * @param {HTMLElement} iconElement - The icon element to update
   * @param {string} countryCode - The country code for the flag class
   */
  function updateFlagClass(iconElement, countryCode) {
    // Remove existing flag classes
    iconElement.className = iconElement.className.replace(/fi-\w+/g, '');

    // Special case for Auto Detect - show globe icon
    if (countryCode === 'auto') {
      iconElement.classList.remove('fi');
      iconElement.textContent = 'ðŸŒ';
    } else {
      iconElement.textContent = '';
      // Add new flag class
      iconElement.classList.add('fi');
      iconElement.classList.add('fi-' + countryCode);
    }
  }

  /**
   * Update language display
   * @param {string} type - 'source', 'target', or undefined for both
   */
  function updateLanguageDisplay(type) {
    if (type === 'source' || type === undefined) {
      const sourceLang = languages.find(lang => lang.languageCode === selectedSourceLanguage);
      document.querySelector('#sourceLanguageGroup .language-text').textContent = sourceLang.name;

      // Update source icon
      const sourceIcon = document.querySelector('#sourceLanguageGroup .language-icon');
      updateFlagClass(sourceIcon, sourceLang.countryCode);
    }

    if (type === 'target' || type === undefined) {
      const targetLang = languages.find(lang => lang.languageCode === selectedTargetLanguage);
      document.querySelector('#targetLanguageGroup .language-text').textContent = targetLang.name;

      // Update target icon
      const targetIcon = document.querySelector('#targetLanguageGroup .language-icon');
      updateFlagClass(targetIcon, targetLang.countryCode);
    }
  }

  /**
   * Setup click outside to close dropdowns
   */
  function setupClickOutside() {
    document.addEventListener('click', function (event) {
      const sourceSelect = document.querySelector('#sourceLanguageGroup .language-select');
      const targetSelect = document.querySelector('#targetLanguageGroup .language-select');

      if (!sourceSelect.contains(event.target) && sourceDropdownOpen) {
        closeSourceDropdown();
      }

      if (!targetSelect.contains(event.target) && targetDropdownOpen) {
        closeTargetDropdown();
      }
    });
  }

  /**
   * Toggle a setting
   * @param {string} settingName - The name of the setting to toggle
   */
  function toggleSetting(settingName) {
    settings[settingName] = !settings[settingName];
    updateToggleStates();
  }

  /**
   * Update toggle switch states
   */
  function updateToggleStates() {
    Object.keys(settings).forEach(setting => {
      const toggle = document.getElementById(setting + 'Toggle');
      if (settings[setting]) {
        toggle.classList.add('active');
      } else {
        toggle.classList.remove('active');
      }
    });
  }

  /**
   * Translate content
   */
  function translateContent() {
    // Disable the translate button
    const translateButton = document.querySelector('.translate-button');
    translateButton.disabled = true;
    translateButton.textContent = 'TRANSLATING...';
    translateButton.classList.add('translating');

    showStatus('Translating...', 'success');

    try {
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        // Convert country codes to language codes
        // selectedSourceLanguage and selectedTargetLanguage are already language codes
        const sourceLang = selectedSourceLanguage;
        const targetLang = selectedTargetLanguage;
        
        google.script.run
          .withSuccessHandler(function (result) {
            if (result.success) {
              showStatus(result.message, 'success');
            } else {
              showStatus(result.message, 'error');
            }
          })
          .withFailureHandler(function(error) {
            showError(error);
          })
          .translateCurrentCell(sourceLang, targetLang);
      } else {
        // Fallback for local development or when Google Apps Script is not available
        showStatus('Google Apps Script environment not available. This is a demo mode.', 'error');
      }
    } catch (error) {
      showError(error);
    } finally {
      enableTranslateButton();
    }
  }

  /**
   * Enable the translate button
   */
  function enableTranslateButton() {
    const translateButton = document.querySelector('.translate-button');
    translateButton.disabled = false;
    translateButton.textContent = 'TRANSLATE';
    translateButton.classList.remove('translating');
  }

  /**
   * Show help overlay
   */
  function showHelp() {
    const overlay = document.getElementById('helpOverlay');
    overlay.style.display = 'flex';
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
  }

  /**
   * Close help overlay
   */
  function closeHelp() {
    const overlay = document.getElementById('helpOverlay');
    overlay.style.display = 'none';
    document.body.style.overflow = 'auto'; // Restore scrolling
  }

  /**
   * Setup help overlay event listeners
   */
  function setupHelpOverlay() {
    const overlay = document.getElementById('helpOverlay');
    
    // Close on overlay background click
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) {
        closeHelp();
      }
    });
    
    // Close on escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && overlay.style.display === 'flex') {
        closeHelp();
      }
    });
  }


  /**
   * Shows a status message
   * @param {string} message - The message to show
   * @param {string} type - The type of message (success or error)
   */
  function showStatus(message, type) {
    const statusDiv = document.getElementById('status');
    statusDiv.textContent = message;
    statusDiv.className = 'status ' + type;
    statusDiv.style.display = 'block';

    // Clear any existing timeout
    if (statusTimeout) {
      clearTimeout(statusTimeout);
    }

    // Hide status after 4 seconds
    statusTimeout = setTimeout(function () {
      statusDiv.style.display = 'none';
      statusTimeout = null;
    }, 4000);
  }

  /**
   * Shows an error message
   * @param {Error} error - The error object
   */
  function showError(error) {
    console.error('Error:', error);
    showStatus('An error occurred: ' + error.message, 'error');
  }
</script>
